<html>
<head>
<!-- React JS -->
<script src="https://fb.me/react-0.14.3.js"></script>
<script src="https://fb.me/react-dom-0.14.3.js"></script>
 <script src="https://fb.me/JSXTransformer-0.13.3.js"></script>
<!-- Firebase -->
<script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
<!-- ReactFire -->
<script src="https://cdn.firebase.com/libs/reactfire/0.5.1/reactfire.min.js"></script>

  <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
  <!-- Firebase -->
  <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
  <!-- ReactFire -->
  <script src="https://cdn.firebase.com/libs/reactfire/0.5.1/reactfire.min.js"></script>
</head>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"></script>
<body>
  <div id="content">
  </div>
  <script type="text/jsx">
    var mountNode = $('#content')[0];
    var LoggedInApp = React.createClass({
     mixins: [ReactFireMixin],
     render: function() { 
      var content;
      if(this.hasCurrentGame()){ 
          var vote = _(this.fibSequenceTo(12)).map(function(n) { 
            return <button data-val={n} key={n} onClick={this.setVote}>{n}</button>;
          }.bind(this));
          vote.push(<button data-val="" key="Clear" onClick={this.setVote}>Clear vote</button>);
          var curVote = this.getVote();
          if(curVote && curVote != ''){ 
            currentVote = <div>Current Vote - {curVote}</div>;
          } else { 
            currentVote = <div>No Vote</div>;
          }
        content = <div>Playing Game - {this.currentGame()}
          <button onClick={this.clearGame}>Leave Game</button>
          {vote}
          {currentVote}
          </div>;
      } else { 
        content = <div>
          Enter game id<input ref="gameIdInput" /><button onClick={this.setGameId}>Set</button>
          </div>
      }
      return <div>
        <div>Welcome {this.props.username}</div>
        {content}
        </div>
     },
     setVote: function(e) { 
      var vote = $(e.target).data('val');
        this.firebaseRefs.user.child('vote').set(vote);
     },
     getVote:function() { 
      return this.state.user.vote;
     },
     setGameId: function() { 
      this.firebaseRefs.user.child('gameId').set(this.refs.gameIdInput.value);
     },
     clearGame: function() { 
      this.firebaseRefs.user.child('gameId').set("");
     },
     componentWillMount: function() { 
     var userRef = new Firebase("https://boiling-inferno-273.firebaseio.com/user/"+this.props.username);
     this.bindAsObject(userRef, "user");
     }, 
     hasCurrentGame: function() { 
      return !!this.state.user.gameId;
     },
    fibSequenceTo: function(n) {
        var a = 0, b = 1, f = 1;
        var nums = [];
        for(var i = 2; i <= n; i++) {
            f = a + b;
            a = b;
            b = f;
            nums.push(f);
        }
        return nums;
    },
     currentGame: function() { 
      var gameId;
      if(gameId = this.state.user.gameId) { 
        return gameId
      } else { 
        return "No game";
      }
     }
   });
    var PlanningPokerApp = React.createClass({
     mixins: [ReactFireMixin],
     render: function() {
      var username = "";
      if(this.state && this.state.user) { 
        username = this.state.user.name
        return <LoggedInApp username={username}></LoggedInApp>;
      } else { 
       return <div>
       <input onChange={this.updateUserName} />
       <button onClick={this.onSetUser}>Set user</button>
         </div>;
      }
   },
   updateUserName: function(e) { 
    this.setState({
      inputUserName: e.target.value
    });
   },
   componentWillMount: function() {
    var storedUsername = localStorage.getItem("username");
      if(storedUsername) { 
        this.setUser(storedUsername);
      }
   },
   onSetUser: function() { 
    this.setUser(this.state.inputUserName);
   },
   setUser: function(username) { 
     var userRef = new Firebase("https://boiling-inferno-273.firebaseio.com/user/"+username);
     this.bindAsObject(userRef, "user");
     this.firebaseRefs.user.child('name').set(username);
     localStorage.setItem("username", username);
   },
});

    ReactDOM.render(<PlanningPokerApp/>, mountNode);
  </script>
</body>
</html>
