<html>

<head>
    <!-- React JS -->
    <script src="https://fb.me/react-0.14.3.js"></script>
    <script src="https://fb.me/react-dom-0.14.3.js"></script>
    <script src="https://fb.me/JSXTransformer-0.13.3.js"></script>
    <!-- Firebase -->
    <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
    <!-- ReactFire -->
    <script src="https://cdn.firebase.com/libs/reactfire/0.5.1/reactfire.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
    <!-- Firebase -->
    <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
    <!-- ReactFire -->
    <script src="https://cdn.firebase.com/libs/reactfire/0.5.1/reactfire.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"></script>
</head>

<body>
    <div id="content">
    </div>
</div>

    <script type="text/jsx">
        var mountNode = $('#content')[0];
        var HostApp = React.createClass({
        	mixins: [ReactFireMixin],
        	render: function() { 

        		if(this.state && this.state.gameId) { 
        			var results;
        			if(this.everyoneHasVoted()) { 
	        			results = _(this.state.players).map(function(player) { 
	        				var vote = (player.vote)?player.vote:"No vote";
	        				return <div>{player.name} - {player.vote}</div>;
	        			});
	        			results.push(<div><button onClick={this.clearVotes}>Clear Votes</button></div>);
	        			results = results.concat(_(this.tallyVotes()).map(function(count, option) { 
	        				var percent = 100*(count/this.state.players.length);
	        				return <div>
    						<div className="progress">
 							 <div className="progress-bar progress-bar-info" style={{width: percent+'%'}}>
 							 {option} - {count} votes
 							 </div>
	        				</div>
	        				</div>;
	        			},this));
        			} else { 
        				results = <div>
        				Not everyone has voted
        				<div> Missing {this.missingPlayers()}</div>
        				</div>;
        			}


        			return <div>
        				<div>Gameid - {this.state.gameId}</div>
        				{results}	
        			</div>
        		} else { 
        			return <div>
        				Enter Game Id <input ref="gameIdInput" />
        				<button onClick={this.setGameId}>Set</button>
        				</div>;
        		}
        	},
        	clearVotes: function() { 
        		_(this.state.players).each(function(player) { 
				     var userRef = new Firebase("https://boiling-inferno-273.firebaseio.com/user/"+player.name);
				     userRef.child('vote').set('');
        		},this);
        	},
        	tallyVotes: function() { 
        		var options = {};
        		_(this.fibSequenceTo(12)).map(function(num) { 
        			options[""+num] = 0;
        		});
        		_(this.state.players).each(function(player) { 
        			if(player.vote && player.vote != '') { 
        				options[player.vote]++;
        			}
        		});
        		return options;
        	},
		    fibSequenceTo: function(n) {
		        var a = 0, b = 1, f = 1;
		        var nums = [];
		        for(var i = 2; i <= n; i++) {
		            f = a + b;
		            a = b;
		            b = f;
		            nums.push(f);
		        }
		        return nums;
		    },
        	missingPlayers: function() { 
        		return _.chain(this.state.players)
        				.filter(function(player) { 
        					return !(player.vote && player.vote != '');
        				})
        				.map(function(player){ 
        					return player.name;
        				})
        				.reduce(function(memo, player) { 
        					return memo+player+',';	
        				},"")
        				.value();
        	},
        	everyoneHasVoted: function() { 
        		return _(this.state.players).reduce(function(memo, player) { 
        			return memo && player.vote && player.vote != '';
        		},true);
        	},
        	setGameId: function() { 
        		var gameId =this.refs.gameIdInput.value;
        		this.setState({
        			gameId: gameId
        		});
        		var playersRef = new Firebase("https://boiling-inferno-273.firebaseio.com/user/").orderByChild("gameId").equalTo(gameId);
        		this.bindAsArray(playersRef, "players");
        	}
        });
        ReactDOM.render(<HostApp/>, mountNode);
    </script>
</body>
